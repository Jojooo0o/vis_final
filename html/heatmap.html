<!DOCTYPE html>
<html>
  <meta charset="utf-8"/>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<head>
  <style type="text/css">
    .states :hover {
      filter: brightness(85%);
    }

    .state-borders {
      fill: none;
      stroke: #fff;
      stroke-width: 0.5px;
      stroke-linejoin: round;
      stroke-linecap: round;
      pointer-events: none;
    }

    .states {
      fill: lightgray;
    }
  </style>
</head>
<body>
  <h1>Mass Shootings per State</h1>
  <svg width="960" height="600"></svg>

  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="https://d3js.org/topojson.v2.min.js"></script>
  <script>

    function calculateGradientColor() {

    }

    // https://stackoverflow.com/questions/728360/how-do-i-correctly-clone-a-javascript-object?page=1&tab=votes#tab-top
    function clone(obj) {
      if (null == obj || "object" != typeof obj) return obj;
      var copy = obj.constructor();
      for (var attr in obj) {
          if (obj.hasOwnProperty(attr)) copy[attr] = obj[attr];
      }
      return copy;
    }

    var dataPaths = ["../data/mass_shootings_2014.csv", "../data/mass_shootings_2015.csv",
                     "../data/mass_shootings_2016.csv", "../data/mass_shootings_2017.csv",
                     "../data/mass_shootings_2018.csv"];

    var incidents = [];

    var svg = d3.select("svg");

    // color gradient
    var defs = svg.append("defs");
    var linearGradient = defs.append("linearGradient")
        .attr("id", "linear-gradient")
        .attr("x1", "0%")
        .attr("y1", "0%")
        .attr("x2", "100%") // horizontal gradient
        .attr("y2", "0%");

    // start color (0%)
    linearGradient.append("stop")
        .attr("offset", "0%")
        .attr("stop-color", "#a1dfe4"); //light blue

    // end color (100%)
    linearGradient.append("stop")
        .attr("offset", "100%")
        .attr("stop-color", "#275154"); //dark blue


    var path = d3.geoPath();

    d3.json("https://d3js.org/us-10m.v1.json", function(error, us) {
    if (error) throw error;

    var parseTime = d3.timeParse("%B %d, %Y");

    d3.queue()
      .defer(d3.csv, dataPaths[0])
      .defer(d3.csv, dataPaths[1])
      .defer(d3.csv, dataPaths[2])
      .defer(d3.csv, dataPaths[3])
      //.defer(d3.csv, dataPaths[4])
      .awaitAll(function (error, d) {
        for(var i = 0; i < d.length; ++i) {
          for(var j = 0; j < d[i].length; ++j) {
            d[i][j].date = parseTime(d[i][j]["Incident Date"]);
            d[i][j].killed = +d[i][j]["# Killed"];
            d[i][j].injured = +d[i][j]["# Injured"];
            d[i][j].state = d[i][j]["State"];
            d[i][j].city = d[i][j]["City Or County"];
          }
        }

      // nest data by state
      for(var i = 0; i < d.length; ++i) {
        var incidentsByState = d3.nest()
          .key(function(d) { return d.state; })
          .rollup(function(s) { return {
            total_incidents: s.length, // amount of incidents in a state
            total_killed: d3.sum(s, function(d) { return d.killed; }),
            total_injured: d3.sum(s, function(d) { return d.injured }),
          }; })
          .entries(d[i]);

          incidents.push(clone(incidentsByState)); // (hack) save copy for every year in incidents
      }

      console.log(incidents);

      // calculate max amount of incidents
      var max = 0;
      var max_incidents = -1;
      for(var i = 0; i < incidents.length; ++i){
        max = d3.max(incidents[i], function(data) { return data.value.total_incidents});
        if(max_incidents < max) {
          max_incidents = max;
        }
      }

      calculateGradientColor(max_incidents);

      console.log(max_incidents);


      // var incidentsByState = d3.nest()
      //   .key(function(d) { return d.state; })
      //   .entries(data);

      });

    svg.append("g")
        .attr("class", "states")
      .selectAll("path")
      .data(topojson.feature(us, us.objects.states).features)
      .enter().append("path")
        .attr("d", path)
        .attr("fill", "url(#linear-gradient)");

    svg.append("path")
        .attr("class", "state-borders")
        .attr("d", path(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; })));
    });
  </script>
</body>
</html>
